<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.S. Apoio | Den√∫ncia (Autocultar Status)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter e aplica um tema escuro padr√£o para discri√ß√£o */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        :root {
            --red-emergency: #e3342f; /* Vermelho vibrante */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Fundo escuro */
            color: #e0e0e0; /* Texto claro */
        }
        .emergency-button {
            width: 180px;
            height: 180px;
            background-color: var(--red-emergency);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(227, 52, 47, 0.8), 0 0 40px rgba(227, 52, 47, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 8px solid rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }
        .emergency-button:active {
            transform: scale(0.95);
            box-shadow: 0 0 10px rgba(227, 52, 47, 0.9);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(227, 52, 47, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(227, 52, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(227, 52, 47, 0); }
        }
        .modal {
            background-color: #1e1e1e;
        }
    </style>
    <svg style="display: none;">
        <symbol id="icon-exit" viewBox="0 0 24 24">
            <path fill="currentColor" d="M16 13H5v-2h11V4l5 5-5 5zM12 21h7a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-7v2h7v14h-7z"/>
        </symbol>
    </svg>
</head>
<body class="h-screen flex flex-col">

    <button id="quickExitBtn" class="absolute top-4 left-4 p-2 rounded-full bg-gray-700 text-white shadow-xl z-50 transition-colors hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-500">
        <svg class="w-6 h-6" fill="currentColor"><use xlink:href="#icon-exit"></use></svg>
        <span class="sr-only">Sair R√°pido</span>
    </button>

    <header class="p-4 pl-16 bg-gray-800 shadow-lg flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-gray-100">S.O.S APP</h1>
        <div class="flex space-x-2 flex-wrap justify-end">
            <button id="btnDenuncia" class="px-3 py-2 bg-blue-600 text-white rounded-full text-sm font-semibold hover:bg-blue-700 transition-colors shadow-md">
                Denuncie Aqui
            </button>
            <button id="btnStats" class="px-3 py-2 bg-purple-600 text-white rounded-full text-sm font-semibold hover:bg-purple-700 transition-colors shadow-md">
                Minhas Den√∫ncias
            </button>
            <button id="btnAjuda" class="px-3 py-2 bg-gray-600 text-white rounded-full text-sm font-semibold hover:bg-gray-700 transition-colors shadow-md">
                ?
            </button>
        </div>
    </header>

    <main id="mainScreen" class="flex-grow flex flex-col items-center justify-center p-4">
        <div class="text-center mb-10">
            <h2 class="text-2xl font-bold mb-2">Emerg√™ncia Imediata</h2>
            <p class="text-gray-400">Pressione e segure para ligar para a Pol√≠cia (190).</p>
        </div>
        
        <a id="emergencyBtn" href="tel:190" class="emergency-button mb-8">
            <span class="text-5xl font-extrabold text-white">190</span>
            <span class="text-lg font-bold text-white mt-1">EMERG√äNCIA</span>
        </a>

        <div id="statusMessage" class="hidden p-4 mt-8 max-w-sm rounded-lg shadow-2xl text-center" role="alert">
            <p class="font-semibold text-lg">Status da A√ß√£o</p>
            <p class="text-sm">Detalhes aqui.</p>
        </div>

        <div id="initialStatus" class="p-3 mt-4 text-center rounded-lg bg-yellow-800 text-yellow-300">
            Conectando ao Firebase...
        </div>
         <p id="userIdDisplay" class="text-xs mt-2 text-gray-600 hidden">ID do Usu√°rio: </p>
    </main>

    <div id="reportFormContainer" class="hidden absolute inset-0 bg-gray-900 bg-opacity-95 overflow-y-auto p-6 z-20">
        <div class="max-w-xl mx-auto bg-gray-800 rounded-xl p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-red-400 mb-4">Denuncie Aqui</h2>
            <p class="text-sm text-gray-400 mb-6 border-b border-gray-700 pb-4">
                <span class="font-bold text-yellow-400">ATEN√á√ÉO:</span> A den√∫ncia ser√° salva de forma segura e sigilosa no nosso servidor Firestore.
            </p>

            <form id="denunciaForm" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <label for="anonimo" class="text-lg font-semibold text-white">Den√∫ncia An√¥nima?</label>
                    <input type="checkbox" id="anonimo" name="anonimo" class="form-checkbox h-5 w-5 text-red-500 rounded focus:ring-red-500 transition duration-150 ease-in-out bg-gray-900 border-gray-600">
                </div>

                <div id="nomeField">
                    <label for="nome" class="block text-sm font-medium text-gray-400">Nome do Denunciante (Opcional)</label>
                    <input type="text" id="nome" name="nome" class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="sexo" class="block text-sm font-medium text-gray-400">Sexo da V√≠tima (Estat√≠stico)</label>
                        <select id="sexo" name="sexo" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white">
                            <option value="" disabled selected>Selecione</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Masculino">Masculino</option>
                            <option value="NaoInformado">N√£o Informado</option>
                        </select>
                    </div>
                    <div>
                        <label for="idade" class="block text-sm font-medium text-gray-400">Idade da V√≠tima (Estat√≠stico)</label>
                        <input type="number" id="idade" name="idade" min="0" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white">
                    </div>
                </div>

                <div id="geoStatus" class="p-3 bg-blue-900 text-blue-300 rounded-lg text-sm hidden">
                    Localiza√ß√£o obtida: Latitude/Longitude registradas para mapeamento.
                </div>
                
                <input type="hidden" id="latitude" name="latitude" value="">
                <input type="hidden" id="longitude" name="longitude" value="">

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-3 sm:col-span-1">
                        <label for="estado" class="block text-sm font-medium text-gray-400">Estado</label>
                        <input type="text" id="estado" name="estado" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white" placeholder="Ex: SP">
                    </div>
                    <div class="col-span-3 sm:col-span-2">
                        <label for="municipio" class="block text-sm font-medium text-gray-400">Munic√≠pio</label>
                        <input type="text" id="municipio" name="municipio" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white" placeholder="Ex: S√£o Paulo">
                    </div>
                </div>
                <div>
                    <label for="bairro" class="block text-sm font-medium text-gray-400">Bairro (Para Mapeamento)</label>
                    <input type="text" id="bairro" name="bairro" class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white" placeholder="Ex: Centro">
                </div>

                <div>
                    <label for="descricao" class="block text-sm font-medium text-gray-400">Descri√ß√£o da Den√∫ncia (O mais detalhado poss√≠vel)</label>
                    <textarea id="descricao" name="descricao" rows="6" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:border-red-500 focus:ring-red-500 text-white"></textarea>
                </div>

                <div id="formStatus" class="mt-4 text-center hidden p-2 rounded-md">Aguarde... Enviando den√∫ncia.</div>
                
                <div class="flex justify-between pt-4">
                    <button type="button" id="cancelDenuncia" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition-colors shadow-md">
                        Cancelar
                    </button>
                    <button type="submit" id="submitDenuncia" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-xl">
                        Salvar Den√∫ncia
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 overflow-y-auto p-6 z-30">
        <div class="max-w-xl mx-auto modal rounded-xl p-6 shadow-2xl">
            <h2 class="text-3xl font-bold text-red-500 mb-6 border-b border-gray-700 pb-2">Ajuda e Orienta√ß√£o</h2>
            <p class="text-gray-300 mb-6">Informa√ß√µes vitais sobre como buscar apoio e prote√ß√£o. Lembre-se, voc√™ n√£o est√° sozinha(o).</p>

            <ul class="space-y-4 text-gray-300">
                <li class="p-3 bg-gray-700 rounded-lg border-l-4 border-red-500">
                    <strong class="text-red-400">Ligue 190 (Pol√≠cia Militar):</strong> Para emerg√™ncias em andamento ou risco imediato √† vida.
                </li>
                <li class="p-3 bg-gray-700 rounded-lg border-l-4 border-blue-500">
                    <strong class="text-blue-400">Ligue 180 (Central de Atendimento √† Mulher):</strong> Para den√∫ncias de viol√™ncia contra a mulher, orienta√ß√µes e encaminhamento.
                </li>
                <li class="p-3 bg-gray-700 rounded-lg border-l-4 border-green-500">
                    <strong class="text-green-400">Conselho Tutelar:</strong> Para casos envolvendo crian√ßas e adolescentes (procure o n√∫mero local).
                </li>
            </ul>

            <button id="closeHelpModal" class="mt-8 w-full py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-xl">
                Entendi, Fechar
            </button>
        </div>
    </div>

    <div id="statsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 overflow-y-auto p-6 z-30">
        <div class="max-w-3xl mx-auto modal rounded-xl p-6 shadow-2xl">
            <h2 class="text-3xl font-bold text-purple-400 mb-6 border-b border-gray-700 pb-2">Minhas Den√∫ncias Salvas (Firestore)</h2>
            <p class="text-gray-300 mb-4">Estas den√∫ncias foram salvas em seu perfil. Apenas voc√™ pode visualiz√°-las.</p>
            
            <div id="statsList" class="space-y-4">
                <p class="text-center text-gray-500 mt-8">Carregando den√∫ncias...</p>
            </div>

            <button id="closeStatsModal" class="mt-8 w-full py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors shadow-xl">
                Fechar
            </button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais de Firebase
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // --- 1. CONFIGURA√á√ÉO DO AMBIENTE ---

        // Configura√ß√£o de Fallback / Direta: USA A CONFIGURA√á√ÉO REAL FORNECIDA PELO USU√ÅRIO.
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA8mUIkIGk-i2RvlrD-_TbLlZJAnOSwgtw",
            authDomain: "sos-app-287a3.firebaseapp.com",
            projectId: "sos-app-287a3",
            storageBucket: "sos-app-287a3.firebasestorage.app",
            messagingSenderId: "365524443228",
            appId: "1:365524443228:web:ad9bf99c80ecaa81d58699",
            measurementId: "G-VTGJGE5SPQ"
        };

        let firebaseConfig = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // PRIORIZA A CONFIGURA√á√ÉO INJETADA PELO AMBIENTE (__firebase_config)
        let configStatus = "connecting";
        
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                // Tenta parsear a string JSON fornecida pelo ambiente
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Configura√ß√£o do Firebase carregada do ambiente.");
            } catch (e) {
                // Se o JSON for inv√°lido, usa o fallback REAL.
                console.error("Erro ao fazer parse de __firebase_config (JSON inv√°lido). Usando config de fallback REAL.", e);
                firebaseConfig = FALLBACK_FIREBASE_CONFIG;
                configStatus = "using_fallback_parse_error";
            }
        } else {
             // Se a vari√°vel global estiver ausente, usa o fallback REAL.
             console.warn("AVISO: Vari√°vel global __firebase_config ausente. Usando configura√ß√£o de fallback (Hardcoded REAL).");
             firebaseConfig = FALLBACK_FIREBASE_CONFIG;
             configStatus = "using_fallback_missing";
        }
        
        // Refer√™ncias DOM
        const btnDenuncia = document.getElementById('btnDenuncia');
        const btnAjuda = document.getElementById('btnAjuda');
        const btnStats = document.getElementById('btnStats');
        const mainScreen = document.getElementById('mainScreen');
        const reportFormContainer = document.getElementById('reportFormContainer');
        const helpModal = document.getElementById('helpModal');
        const statsModal = document.getElementById('statsModal');
        const statsList = document.getElementById('statsList');
        const closeStatsModal = document.getElementById('closeStatsModal');
        const denunciaForm = document.getElementById('denunciaForm');
        const nomeField = document.getElementById('nomeField');
        const anonimoCheckbox = document.getElementById('anonimo');
        const cancelDenuncia = document.getElementById('cancelDenuncia');
        const closeHelpModal = document.getElementById('closeHelpModal');
        const statusMessage = document.getElementById('statusMessage');
        const quickExitBtn = document.getElementById('quickExitBtn');
        const initialStatusDiv = document.getElementById('initialStatus');
        const formStatus = document.getElementById('formStatus');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Campos de Geocoordenadas
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const geoStatusDiv = document.getElementById('geoStatus');


        /**
         * Atualiza o estado visual de conex√£o.
         * @param {'connecting' | 'connected' | 'error' | 'permissions' | 'no_config'} status 
         * @param {string} message 
         */
        function updateStatus(status, message, id = null) {
            // Garante que o status box esteja vis√≠vel para a atualiza√ß√£o
            initialStatusDiv.classList.remove('hidden'); 
            initialStatusDiv.textContent = message;
            initialStatusDiv.classList.remove('bg-yellow-800', 'bg-green-800', 'bg-red-800', 'bg-orange-800', 'bg-gray-800');
            
            if (status === 'connecting') {
                initialStatusDiv.classList.add('bg-yellow-800');
            } else if (status === 'connected') {
                initialStatusDiv.classList.add('bg-green-800');
                userIdDisplay.textContent = `ID do Usu√°rio: ${id}`;
                // Garante que o ID do usu√°rio est√° vis√≠vel ap√≥s o sucesso
                userIdDisplay.classList.remove('hidden'); 
                btnDenuncia.disabled = false;
                btnDenuncia.classList.remove('bg-gray-500', 'cursor-not-allowed');
                btnDenuncia.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else if (status === 'error' || status === 'no_config') {
                initialStatusDiv.classList.add('bg-red-800');
                userIdDisplay.classList.add('hidden'); // Oculta o ID em caso de erro cr√≠tico
                // Desativa a den√∫ncia se houver falha cr√≠tica
                btnDenuncia.disabled = true;
                btnDenuncia.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnDenuncia.classList.add('bg-gray-500', 'cursor-not-allowed');
            } else if (status === 'permissions') {
                initialStatusDiv.classList.add('bg-orange-800');
            }
        }

        /**
         * Constr√≥i e retorna a refer√™ncia da cole√ß√£o de den√∫ncias privadas do usu√°rio.
         */
        function getReportsCollectionRef() {
            // Caminho privado: /artifacts/{appId}/users/{userId}/denuncias_pessoais
            const path = `/artifacts/${appId}/users/${userId}/denuncias_pessoais`;
            return collection(db, path);
        }

        // üü¢ NOVO: Fun√ß√£o para obter a refer√™ncia da cole√ß√£o p√∫blica (Painel de Visualiza√ß√£o)
        function getPublicReportsCollectionRef() {
            // Caminho p√∫blico: /artifacts/{appId}/denuncias_publicas
            const path = `/artifacts/${appId}/denuncias_publicas`;
            return collection(db, path);
        }

        let unsubscribeReports = null;
        let personalReports = [];

        /**
         * Configura o listener em tempo real para as den√∫ncias pessoais do usu√°rio.
         */
        function setupReportsListener() {
            if (!db || !isAuthReady || !userId) {
                return;
            }
            
            // Se j√° houver um listener, desinscreve para evitar duplica√ß√£o.
            if (unsubscribeReports) {
                 unsubscribeReports();
            }

            const reportsRef = getReportsCollectionRef();
            const q = query(reportsRef);

            unsubscribeReports = onSnapshot(q, (snapshot) => {
                personalReports = [];
                snapshot.forEach((doc) => {
                    personalReports.push({ id: doc.id, ...doc.data() });
                });
                if (!statsModal.classList.contains('hidden')) {
                    renderPersonalReports();
                }
            }, (error) => {
                console.error("Erro ao escutar den√∫ncias (Regras de Seguran√ßa):", error);
                // O erro de permiss√£o √© o mais comum aqui se as regras estiverem erradas.
                updateStatus('permissions', "AVISO: Falha ao carregar den√∫ncias. Verifique as regras de seguran√ßa do Firestore.", userId);
                personalReports = [];
            });
        }


        /**
         * Renderiza as den√∫ncias pessoais na modal de estat√≠sticas.
         */
        function renderPersonalReports() {
            if (personalReports.length === 0) {
                statsList.innerHTML = `<p class="text-center text-gray-500 mt-8">Nenhuma den√∫ncia encontrada no servidor.</p>`;
                return;
            }

            let htmlContent = '';
            personalReports.forEach((data) => {
                // Tenta formatar a data, se for um ISO string v√°lido
                let dateStr = 'Data Desconhecida';
                try {
                    dateStr = new Date(data.timestamp).toLocaleString('pt-BR');
                } catch (e) {
                    dateStr = data.timestamp; // Caso o formato n√£o seja reconhecido
                }
                
                htmlContent += `
                    <div class="bg-gray-700 p-4 rounded-lg shadow-xl border-l-4 border-purple-500">
                        <p class="text-xs text-gray-400 mb-1">ID Den√∫ncia: ${data.id} | Data: ${dateStr}</p>
                        <h4 class="text-lg font-semibold text-white mb-2">${data.anonimo ? 'Den√∫ncia An√¥nima' : data.nomeDenunciante}</h4>
                        <p class="text-sm text-gray-300"><strong>Local:</strong> ${data.municipio} - ${data.estado}</p>
                        <p class="text-sm text-gray-300"><strong>V√≠tima:</strong> ${data.sexo}, ${data.idade} anos.</p>
                        <p class="mt-3 text-sm italic text-gray-200 border-t border-gray-600 pt-2">${data.descricao}</p>
                    </div>
                `;
            });

            statsList.innerHTML = htmlContent;
        }


        // --- 2. Inicializa√ß√£o e Autentica√ß√£o ---

        async function initApp() {
            setLogLevel('debug'); // Ativa logs de debug do Firebase
            updateStatus('connecting', "Conectando ao Firebase e autenticando...");

            if (!firebaseConfig) {
                 updateStatus('no_config', "ERRO FATAL: Configura√ß√£o do Firebase Ausente. N√£o √© poss√≠vel salvar dados.");
                 isAuthReady = false;
                 return; 
            }
            
            // NOVO LOG DE DEBUG: Confirma√ß√£o da Configura√ß√£o sendo usada
            console.log("Configura√ß√£o FINAL do Firebase sendo usada:", firebaseConfig);

            try {
                // 1. Inicializa o App, Firestore e Auth usando a config obtida
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let userCredential = null;
                
                // 2. Tenta Autentica√ß√£o com Token Customizado (se dispon√≠vel)
                if (initialAuthToken) {
                    try {
                        console.log("Tentando autentica√ß√£o com Token Customizado...");
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Sucesso na Autentica√ß√£o com Token Customizado.");
                    } catch (e) {
                        console.warn(`Falha na autentica√ß√£o Customizada (${e.code}). Tentando Autentica√ß√£o An√¥nima como fallback...`);
                    }
                } 

                // 3. Se n√£o logou (ou falhou no custom token), tenta o login an√¥nimo
                if (!userCredential) {
                    console.log("Tentando Autentica√ß√£o An√¥nima...");
                    userCredential = await signInAnonymously(auth);
                }
                
                // 4. Finaliza o login
                if (userCredential && userCredential.user) {
                    userId = userCredential.user.uid;
                    isAuthReady = true;

                    // Exibe o status de sucesso
                    updateStatus('connected', "Conex√£o com Firestore estabelecida com sucesso. Login An√¥nimo OK.", userId);
                    
                    // NOVO: Agenda o ocultamento da mensagem de status ap√≥s 5 segundos
                    setTimeout(() => {
                        // Verifica se a mensagem ainda √© de sucesso antes de ocultar
                        if (initialStatusDiv.textContent.includes("Login An√¥nimo OK.")) {
                            initialStatusDiv.classList.add('hidden');
                        }
                    }, 5000);

                    // Configura o listener APENAS AP√ìS a autentica√ß√£o
                    setupReportsListener(); 
                } else {
                     throw new Error("Falha na Autentica√ß√£o: Nenhum usu√°rio foi logado.");
                }


            } catch (error) {
                console.error("ERRO CR√çTICO na Inicializa√ß√£o/Autentica√ß√£o:", error);
                
                let errorMessage = `ERRO CR√çTICO: Falha de conex√£o. O Firebase retornou o erro: ${error.code || 'Desconhecido'}`;
                
                if (error.code === 'auth/configuration-not-found') {
                    // MENSAGEM CHAVE PARA O USU√ÅRIO
                    errorMessage = "ERRO FATAL (AUTH): O Login An√¥nimo N√ÉO est√° ativado no seu Firebase Console. Por favor, ATIVE-O em Authentication > Sign-in method > An√¥nimo.";
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorMessage = "ERRO FATAL (API KEY): A CHAVE DE API REAL √â INV√ÅLIDA.";
                } else if (error.code === 'permission-denied') {
                    errorMessage = "ERRO DE PERMISS√ÉO: A conex√£o foi feita, mas as REGRAS DE SEGURAN√áA impediram o acesso.";
                } else if (error.code === 'auth/configuration-not-found' || error.code === 'app/invalid-credentials') {
                    errorMessage = "ERRO FATAL: Configura√ß√£o do Firebase Incorreta. Verifique se todos os valores (apiKey, authDomain, projectId) s√£o v√°lidos.";
                }
                
                // Mensagem de erro permanece vis√≠vel
                updateStatus('error', errorMessage);
                isAuthReady = false;
            }
        }


        // --- 3. L√≥gica de Fun√ß√µes Comuns ---

        // Fun√ß√£o para Obter Geocaliza√ß√£o
        function getGeolocation() {
            if ("geolocation" in navigator) {
                geoStatusDiv.textContent = "Tentando obter sua localiza√ß√£o para mapeamento...";
                geoStatusDiv.classList.remove('hidden');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        latitudeInput.value = lat;
                        longitudeInput.value = lon;

                        geoStatusDiv.textContent = "Localiza√ß√£o obtida: Latitude/Longitude registradas para mapeamento.";
                        geoStatusDiv.classList.remove('bg-red-900');
                        geoStatusDiv.classList.add('bg-blue-900');
                    },
                    (error) => {
                        latitudeInput.value = '';
                        longitudeInput.value = '';
                        geoStatusDiv.textContent = "N√£o foi poss√≠vel obter a localiza√ß√£o. Preencha o Estado e Munic√≠pio manualmente.";
                        geoStatusDiv.classList.remove('bg-blue-900');
                        geoStatusDiv.classList.add('bg-red-900');
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            } else {
                geoStatusDiv.textContent = "Geolocaliza√ß√£o n√£o suportada. Preencha todos os campos de endere√ßo.";
                geoStatusDiv.classList.remove('hidden');
                geoStatusDiv.classList.add('bg-red-900');
            }
        }


        // L√≥gica de Envio da Den√∫ncia (SALVA NO FIRESTORE)
        async function submitDenuncia(event) {
            event.preventDefault();

            if (!isAuthReady || !db || !userId) {
                formStatus.textContent = `ERRO: Conex√£o com o servidor indispon√≠vel. Corrija o erro no status de conex√£o (topo) antes de denunciar.`;
                formStatus.classList.remove('hidden', 'bg-yellow-900', 'text-yellow-300');
                formStatus.classList.add('bg-red-900', 'text-red-300');
                setTimeout(() => formStatus.classList.add('hidden'), 5000);
                return;
            }
            
            formStatus.textContent = "Aguarde... Enviando den√∫ncia para o servidor.";
            formStatus.classList.remove('hidden', 'bg-red-900', 'text-red-300');
            formStatus.classList.add('bg-yellow-900', 'text-yellow-300');
            
            const formData = new FormData(denunciaForm);
            const data = {
                // Dados Est√°ticos para Mapeamento
                sexo: formData.get('sexo'),
                idade: parseInt(formData.get('idade'), 10) || 0,
                bairro: formData.get('bairro') || 'N/A',
                municipio: formData.get('municipio'),
                estado: formData.get('estado'),
                descricao: formData.get('descricao'), // Conte√∫do Sigiloso

                // Dados de Geolocaliza√ß√£o (de alta precis√£o)
                latitude: formData.get('latitude') || 'N/A',
                longitude: formData.get('longitude') || 'N/A',

                // Metadados
                anonimo: anonimoCheckbox.checked,
                nomeDenunciante: anonimoCheckbox.checked ? 'Denunciante An√¥nimo' : (formData.get('nome') || 'N√£o Informado'),
                timestamp: new Date().toISOString(),
                userId: userId, // ID de usu√°rio do Firebase
            };

            try {
                // 1. SALVAR NA COLE√á√ÉO PRIVADA (para o pr√≥prio usu√°rio - Minhas Den√∫ncias)
                const privateReportsRef = getReportsCollectionRef();
                await addDoc(privateReportsRef, data);
                
                // 2. üö® CR√çTICO: SALVAR NA COLE√á√ÉO P√öBLICA (para o Painel de Admin) üö®
                const publicReportsRef = getPublicReportsCollectionRef();
                await addDoc(publicReportsRef, data);

                denunciaForm.reset();
                showScreen('main');
                statusMessage.classList.remove('hidden', 'bg-red-800'); 
                statusMessage.classList.add('bg-green-800');
                statusMessage.querySelector('p:nth-child(1)').textContent = 'Den√∫ncia Salva e Encaminhada com Sucesso!';
                statusMessage.querySelector('p:nth-child(2)').textContent = 'Seus dados foram salvos e encaminhados para a central de monitoramento.';
                
            } catch (error) {
                console.error("Erro ao salvar a den√∫ncia no Firestore:", error);
                
                let errorMsg = `Falha ao salvar. Verifique as permiss√µes.`;
                if (error.code === 'permission-denied') {
                    errorMsg = `Falha: Permiss√£o Negada. Cheque as Regras de Seguran√ßa.`;
                }

                statusMessage.classList.remove('hidden', 'bg-green-800'); 
                statusMessage.classList.add('bg-red-800');
                statusMessage.querySelector('p:nth-child(1)').textContent = 'ERRO DE SERVIDOR!';
                statusMessage.querySelector('p:nth-child(2)').textContent = errorMsg;
                formStatus.textContent = `ERRO: ${errorMsg}`;
                formStatus.classList.remove('bg-yellow-900', 'text-yellow-300');
                formStatus.classList.add('bg-red-900', 'text-red-300');

            } finally {
                // Esconde as mensagens de status ap√≥s 5 segundos
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                    formStatus.classList.add('hidden');
                }, 5000);
            }
        }


        // Fun√ß√µes de Gerenciamento de Visualiza√ß√£o
        function showScreen(screen) {
            // Oculta todas as telas e mensagens
            // NOTA: initialStatusDiv n√£o √© ocultado aqui porque √© gerido pelo initApp para persistir erros.
            mainScreen.classList.add('hidden');
            reportFormContainer.classList.add('hidden');
            helpModal.classList.add('hidden');
            statsModal.classList.add('hidden');
            statusMessage.classList.add('hidden');
            geoStatusDiv.classList.add('hidden');

            if (screen === 'main') {
                mainScreen.classList.remove('hidden');
            } else if (screen === 'report') {
                reportFormContainer.classList.remove('hidden');
                getGeolocation();
            } else if (screen === 'help') {
                helpModal.classList.remove('hidden');
            } else if (screen === 'stats') {
                statsModal.classList.remove('hidden');
                if (isAuthReady) {
                    renderPersonalReports();
                } else {
                    statsList.innerHTML = `<p class="text-center text-red-500 mt-8">N√£o foi poss√≠vel carregar: Conex√£o com o servidor falhou. Verifique se o login an√¥nimo est√° ativo no Firebase.</p>`;
                }
            }
        }

        // L√≥gica de Event Listeners
        document.addEventListener('DOMContentLoaded', () => {

            // Inicia o processo de autentica√ß√£o e conex√£o com o banco de dados
            initApp();

            // Alternar anonimato
            anonimoCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    nomeField.classList.add('hidden');
                } else {
                    nomeField.classList.remove('hidden');
                }
            });

            // Bot√µes de navega√ß√£o
            btnDenuncia.addEventListener('click', () => showScreen('report'));
            cancelDenuncia.addEventListener('click', () => showScreen('main'));
            btnAjuda.addEventListener('click', () => showScreen('help'));
            closeHelpModal.addEventListener('click', () => showScreen('main'));
            btnStats.addEventListener('click', () => showScreen('stats'));
            closeStatsModal.addEventListener('click', () => showScreen('main'));

            // Bot√£o de Sa√≠da R√°pida (Sair R√°pido)
            quickExitBtn.addEventListener('click', () => {
                window.location.href = 'https://www.google.com/search?q=previs%C3%A3o+do+tempo';
            });

            // Submiss√£o do Formul√°rio
            denunciaForm.addEventListener('submit', submitDenuncia);
        });

    </script>

</body>
</html>